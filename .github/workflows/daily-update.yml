name: Daily Update

on:
  push:
    branches:
    - main
  schedule:
  - cron: '30 4 15 * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all configs'
        required: false
        default: false
        type: boolean

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup environment and script permissions
      run: |
        # åªéœ€è¦ç»™ä¸€ä¸ªè„šæœ¬æŽˆæƒ
        chmod +x main.sh

    # æ–°çš„ã€ç»Ÿä¸€çš„å›¾æ ‡å¤„ç†æ­¥éª¤
    - name: Process Icons and Generate All JSON Files
      id: process_icons
      run: |
        echo "### ðŸš€ Starting Unified Icon Processing..."
        ./main.sh

    # README ç”Ÿæˆæ­¥éª¤ä¿æŒä¸å˜ï¼Œå®ƒä¾èµ–äºŽä¸Šä¸€æ­¥ç”Ÿæˆçš„æ–‡ä»¶
    - name: Generate README.md
      shell: bash
      run: |
        echo "### ðŸ“š Generating README.md"

        TABLE_TMP_FILE=$(mktemp)
        trap 'rm -f -- "$TABLE_TMP_FILE"' EXIT

        echo "| é…ç½®åç§° | CDN é“¾æŽ¥ |" > "$TABLE_TMP_FILE"
        echo "|:---|:---|" >> "$TABLE_TMP_FILE"

        grep -v '^\s*#' config.csv | grep -v '^\s*$' | while IFS=, read -r comment src_url path; do
          comment=$(echo "$comment" | xargs); path=$(echo "$path" | xargs)
          if [[ -n "$path" ]]; then
            cdn_link="https://cdn.jsdelivr.net/gh/${{ github.repository }}@main/$path"
            echo "| $comment | [\`$path\`]($cdn_link) |" >> "$TABLE_TMP_FILE"
          fi
        done

        SOURCE_LIST=$(
          awk -F'[[:space:]]*,[[:space:]]*' '
            !/^#/ && NF > 2 {
                url = $2;
                if (match(url, /(github\.com|raw\.githubusercontent\.com)\/([^\/]+)\/([^\/]+)/, parts)) {
                    author = parts[2]; repo = parts[3];
                    if (!seen[author]++) {
                        printf "- **%s**: [`%s`](https://github.com/%s/%s)\n", author, repo, author, repo
                    }
                }
            }
          ' config.csv | sort -u
        )

        cat > README.md <<EOF
        # Emby Icons CDN Collection

        æœ¬ä»“åº“æ—¨åœ¨æ”¶é›†å¹¶å½’é›†å„ç±» Emby å›¾æ ‡é›†ï¼Œåˆ©ç”¨ jsDelivr CDN æä¾›ç¨³å®šã€é«˜é€Ÿçš„è®¿é—®æœåŠ¡ã€‚**æ‰€æœ‰å›¾æ ‡èµ„æºå‡å·²ä¸‹è½½å¹¶å­˜å‚¨åœ¨æœ¬ä»“åº“å†…ï¼Œç¡®ä¿é•¿æœŸå¯ç”¨ã€‚**

        ## ðŸŒŸ All-in-One è¶…çº§åˆé›†

        | é…ç½®åç§° | CDN é“¾æŽ¥ | è¯´æ˜Ž |
        |:---|:---|:---|
        | å…¨éƒ¨å›¾æ ‡åˆé›† (æœ¬åœ°ç‰ˆ) | [\`icons/allinone.json\`](https://cdn.jsdelivr.net/gh/${{ github.repository }}@main/icons/allinone.json) | ðŸŽ¯ æ•´åˆæ‰€æœ‰å›¾æ ‡æºï¼Œå›¾ç‰‡å·²å…¨éƒ¨ä¸‹è½½è‡³æœ¬ä»“åº“å¹¶è¿›è¡ŒMD5åŽ»é‡ï¼ŒæŒ‰åç§°æŽ’åºã€‚ |

        ## ðŸ“ åˆ†ç±»å›¾æ ‡é…ç½®æ–‡ä»¶

        $(cat "$TABLE_TMP_FILE")

        ## ðŸš€ ä½¿ç”¨æ–¹æ³•

        ç›´æŽ¥å¤åˆ¶ä¸Šè¡¨ä¸­æ‚¨éœ€è¦çš„ CDN é“¾æŽ¥ï¼Œåœ¨æ”¯æŒè¯¥æ ¼å¼çš„å®¢æˆ·ç«¯ï¼ˆå¦‚ Forwardã€Hills ç­‰ï¼‰ä¸­è¿›è¡Œé…ç½®å³å¯ã€‚

        ### ç¤ºä¾‹

        \`\`\`txt
        https://cdn.jsdelivr.net/gh/${{ github.repository }}@main/icons/baiitang_yuan_tubiao.json
        \`\`\`

        æ‰€æœ‰å›¾æ ‡å›¾ç‰‡èµ„æºæ‰˜ç®¡äºŽ [\`icons/assets\`](icons/assets) ç›®å½•ã€‚

        ## ðŸ“‹ é…ç½®æ–‡ä»¶æ¥æº

        ${SOURCE_LIST}

        ## ðŸ”„ æ›´æ–°æœºåˆ¶

        - **å®šæ—¶æ›´æ–°**: æ¯æœˆ15æ—¥è‡ªåŠ¨æ‰§è¡Œï¼ŒåŒæ­¥ä¸Šæ¸¸å˜æ›´ã€‚
        - **æ‰‹åŠ¨è§¦å‘**: å¯åœ¨ Actions é¡µé¢æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµï¼Œç«‹å³èŽ·å–æœ€æ–°å›¾æ ‡ã€‚
        - **æŽ¨é€æ›´æ–°**: å‘ \`main\` åˆ†æ”¯çš„ä»»ä½•æŽ¨é€éƒ½ä¼šè§¦å‘æ›´æ–°ã€‚

        ## ðŸ¤ è´¡çŒ®

        æ¬¢è¿Žé€šè¿‡ Pull Request æˆ– Issue æ·»åŠ æ–°çš„å›¾æ ‡æºã€‚è¯·æŒ‰ä»¥ä¸‹æ ¼å¼ç¼–è¾‘ \`config.csv\` æ–‡ä»¶ï¼š

        \`\`\`csv
        # æ ¼å¼: é…ç½®åç§°, æºURL, åœ¨æœ¬ä»“åº“çš„ç›®æ ‡è·¯å¾„
        My Favorite Icons, https://example.com/icons/tubiao.json, icons/my_favorite_tubiao.json
        \`\`\`

        ---
        *This README is automatically generated by actions workflow.*
        EOF

    - name: Commit and push changes
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # æ·»åŠ æ‰€æœ‰å˜æ›´, åŒ…æ‹¬æ–°å¢žçš„å›¾ç‰‡èµ„æº
        git add -A
        if git diff --staged --quiet; then
          echo "No changes to commit."
          exit 0
        fi

        case "${{ github.event_name }}" in
          schedule) COMMIT_MSG="Scheduled Update: Sync icon sets and localize assets" ;;
          workflow_dispatch) COMMIT_MSG="Manual Update: Sync icon sets and localize assets" ;;
          *) COMMIT_MSG="Auto Update: Sync icon sets and localize assets" ;;
        esac

        git commit -m "$COMMIT_MSG @ $(date +'%Y-%m-%d %H:%M:%S %Z')"
        git push

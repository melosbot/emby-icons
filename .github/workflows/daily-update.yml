name: Daily Update

on:
  push:
    branches:
    - main
  schedule:
  - cron: '30 4 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all configs'
        required: false
        default: false
        type: boolean

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Process Icons and Generate All JSON Files
      id: process_icons
      run: |
        echo "### ðŸš€ Starting Unified Icon Processing (Python)..."
        # å°† github.repository ä½œä¸ºå‚æ•°ä¼ é€’ç»™è„šæœ¬
        python main.py "${{ github.repository }}"
      env:
        GITHUB_EVENT_NAME: ${{ github.event_name }}

    - name: Generate README.md
      shell: bash
      run: |
        echo "### ðŸ“š Generating README.md"
        # README ç”Ÿæˆé€»è¾‘ä¿æŒä¸å˜ï¼Œå› ä¸º config.csv æ ¼å¼æ²¡æœ‰å˜
        TABLE_TMP_FILE=$(mktemp)
        trap 'rm -f -- "$TABLE_TMP_FILE"' EXIT
        echo "| é…ç½®åç§° | CDN é“¾æŽ¥ |" > "$TABLE_TMP_FILE"
        echo "|:---|:---|" >> "$TABLE_TMP_FILE"
        grep -v '^\s*#' config.csv | grep -v '^\s*$' | while IFS=, read -r comment src_url path; do
          comment=$(echo "$comment" | xargs); path=$(echo "$path" | xargs)
          if [[ -n "$path" ]]; then
            cdn_link="https://cdn.jsdelivr.net/gh/${{ github.repository }}@main/$path"
            echo "| $comment | [\`$path\`]($cdn_link) |" >> "$TABLE_TMP_FILE"
          fi
        done
        SOURCE_LIST=$(awk -F'[[:space:]]*,[[:space:]]*' '!/^#/ && NF > 2 {url = $2; if (match(url, /(github\.com|raw\.githubusercontent\.com)\/([^\/]+)\/([^\/]+)/, parts)) {author = parts[2]; repo = parts[3]; if (!seen[author]++) {printf "- **%s**: [`%s`](https://github.com/%s/%s)\n", author, repo, author, repo}}}' config.csv | sort -u)
        cat > README.md <<EOF
        # Emby Icons CDN Collection

        æœ¬ä»“åº“æ—¨åœ¨æ”¶é›†å¹¶å½’é›†å„ç±» Emby å›¾æ ‡é›†ï¼Œåˆ©ç”¨ jsDelivr CDN æä¾›ç¨³å®šã€é«˜é€Ÿçš„è®¿é—®æœåŠ¡ã€‚**æ‰€æœ‰å›¾æ ‡èµ„æºå‡å·²ä¸‹è½½å¹¶å­˜å‚¨åœ¨æœ¬ä»“åº“å†…ï¼Œç¡®ä¿é•¿æœŸå¯ç”¨ã€‚**

        ## ðŸŒŸ All-in-One è¶…çº§åˆé›†

        | é…ç½®åç§° | CDN é“¾æŽ¥ | è¯´æ˜Ž |
        |:---|:---|:---|
        | å…¨éƒ¨å›¾æ ‡åˆé›† | [\`icons/allinone.json\`](https://cdn.jsdelivr.net/gh/${{ github.repository }}@main/icons/allinone.json) | ðŸŽ¯ æ•´åˆæ‰€æœ‰å›¾æ ‡æºï¼Œå›¾ç‰‡å·²å…¨éƒ¨ä¸‹è½½è‡³æœ¬ä»“åº“å¹¶è¿›è¡ŒMD5åŽ»é‡ï¼Œé€šè¿‡ jsDelivr CDN åŠ é€Ÿã€‚ |

        ## ðŸ“ åˆ†ç±»å›¾æ ‡é…ç½®æ–‡ä»¶

        $(cat "$TABLE_TMP_FILE")

        ## ðŸš€ ä½¿ç”¨æ–¹æ³•

        ç›´æŽ¥å¤åˆ¶ä¸Šè¡¨ä¸­æ‚¨éœ€è¦çš„ CDN é“¾æŽ¥ï¼Œåœ¨æ”¯æŒè¯¥æ ¼å¼çš„å®¢æˆ·ç«¯ä¸­è¿›è¡Œé…ç½®å³å¯ã€‚

        ### ç¤ºä¾‹

        \`\`\`txt
        https://cdn.jsdelivr.net/gh/${{ github.repository }}@main/icons/baiitang_yuan_tubiao.json
        \`\`\`

        æ‰€æœ‰å›¾æ ‡å›¾ç‰‡èµ„æºæ‰˜ç®¡äºŽ [\`icons/assets\`](icons/assets) ç›®å½•ã€‚

        ## ðŸ“‹ æ¥æºå’Œè‡´è°¢

        æœ¬ä»“åº“æ”¶é›†äº†å¤šä¸ªå¼€æºå›¾æ ‡æºï¼Œæ„Ÿè°¢ä»¥ä¸‹ä½œè€…å’Œé¡¹ç›®çš„è´¡çŒ®ï¼š

        ${SOURCE_LIST}

        ## ðŸ”„ æ›´æ–°æœºåˆ¶

        - **å®šæ—¶æ›´æ–°**: æ¯æ—¥è‡ªåŠ¨æ‰§è¡Œï¼ŒåŒæ­¥ä¸Šæ¸¸å˜æ›´ã€‚
        - **æ‰‹åŠ¨è§¦å‘**: å¯åœ¨ Actions é¡µé¢æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµï¼Œç«‹å³èŽ·å–æœ€æ–°å›¾æ ‡ã€‚
        - **æŽ¨é€æ›´æ–°**: å‘ \`main\` åˆ†æ”¯çš„ä»»ä½•æŽ¨é€éƒ½ä¼šè§¦å‘æ›´æ–°ã€‚

        ## ðŸ¤ è´¡çŒ®

        æ¬¢è¿Žé€šè¿‡ Pull Request æˆ– Issue æ·»åŠ æ–°çš„å›¾æ ‡æºã€‚è¯·æŒ‰ä»¥ä¸‹æ ¼å¼ç¼–è¾‘ \`config.csv\` æ–‡ä»¶ï¼š

        \`\`\`csv
        # æ ¼å¼: é…ç½®åç§°, æºURL, åœ¨æœ¬ä»“åº“çš„ç›®æ ‡è·¯å¾„
        My Favorite Icons, https://example.com/icons/tubiao.json, icons/my_favorite_tubiao.json
        \`\`\`

        *This README is automatically generated by actions workflow.*
        EOF

    - name: Commit and push changes
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add -A
        if git diff --staged --quiet; then
          echo "No changes to commit."
          exit 0
        fi
        git commit -F commit_message.txt
        git push
